import fpdf
import os
import pandas as pd
import yaml

def create_report(output_orig, output_plot_path, report_name):
    with open(os.path.join(output_orig, 'report_summary.yaml'), 'r') as infile:
        report_summary = yaml.load(infile)

    pdf = fpdf.FPDF()
    pdf.add_page()
    pdf.set_xy(0, 0)
    pdf.set_font('Arial', '', 11)
    pdf.cell(90, 10, " ", 0, 1, 'C')
    pdf.cell(90, 10, " ", 0, 1, 'C')
    pdf.cell(10)
    pdf.cell(10)
    pdf.cell(100, 8, "Optocoder QC Sheet", 0, 1, 'L')
    pdf.cell(90, 8, " ", 0, 1, 'C')
    pdf.cell(10)
    pdf.cell(40, 8, 'Puck ID', 1, 0, 'C')
    pdf.cell(40, 8, '# Cycles', 1, 0, 'C')
    pdf.cell(40, 8, '# Detected Beads', 1, 1, 'C')
    pdf.cell(10)
    pdf.cell(40, 8, report_summary['puck_id'], 1, 0, 'C')
    pdf.cell(40, 8, format(report_summary['num_cycles'], ','), 1, 0, 'C')
    pdf.cell(40, 8, format(report_summary['num_beads'], ','), 1, 1, 'C')

    pdf.cell(90, 8, " ", 0, 1, 'C')
    pdf.cell(10)
    pdf.cell(60, 8, "Basecalling Method", 1, 0, 'C')
    pdf.cell(60, 8, '# Unique Barcodes', 1, 0, 'C')

    pdf.ln(h='')
    pdf.cell(10)
    pdf.cell(60, 8, "Naive", 1, 0, 'C')
    pdf.cell(60, 8, format(report_summary['unique_barcodes']['naive'], ','), 1, 0, 'C')
    pdf.ln(h='')
    pdf.cell(10)
    pdf.cell(60, 8, "Only Crosstalk Correction", 1, 0, 'C')
    pdf.cell(60, 8, format(report_summary['unique_barcodes']['only_ct'], ','), 1, 0, 'C')
    pdf.ln(h='')
    pdf.cell(10)
    pdf.cell(60, 8, "Crosstalk + Phasing Correction", 1, 0, 'C')
    pdf.cell(60, 8, format(report_summary['unique_barcodes']['phasing'], ','), 1, 0, 'C')

    pdf.ln(h='')
    pdf.cell(10, 10, " ", 0, 1, 'C')
    pdf.cell(80, 8, "Average Raw Intensities", 1, 0, 'C')
    pdf.image(os.path.join(output_plot_path, 'average_intensities.png'), x=35, y=115, w=120, h=70, type='', link='')
    pdf.ln(h='')
    pdf.cell(10, 80, " ", 0, 1, 'C')

    pdf.cell(120, 8, "Registration Score (Higher is better)", 1, 0, 'C')
    pdf.image(os.path.join(output_plot_path, 'reg_score.png'), x=35, y=200, w=120, h=70, type='', link='')
    pdf.add_page()

    pdf.cell(110, 8, "Basecalling fractions of the barcodes", 1, 1, 'C')
    pdf.image(os.path.join(output_plot_path, 'fractions_naive.png'), x=35, y=20, w=120, h=70, type='', link='')
    pdf.ln(h='')
    pdf.cell(10, 10, " ", 0, 1, 'C')
    pdf.image(os.path.join(output_plot_path, 'fractions_only_ct.png'), x=35, y=100, w=120, h=70, type='', link='')
    pdf.ln(h='')
    pdf.cell(10, 10, " ", 0, 1, 'C')
    pdf.image(os.path.join(output_plot_path, 'fractions_phasing.png'), x=35, y=180, w=120, h=70, type='', link='')

    pdf.ln(h='')
    pdf.cell(90, 50, " ", 0, 1, 'C')
    pdf.add_page()

    pdf.cell(110, 8, "Entropy of barcodes (higher values are better) ", 1, 1, 'C')
    pdf.image(os.path.join(output_plot_path, 'entropy_histogram_naive.png'), x=35, y=20, w=120, h=70, type='', link='')
    pdf.ln(h='')
    pdf.cell(10, 10, " ", 0, 1, 'C')
    pdf.image(os.path.join(output_plot_path, 'entropy_histogram_only_ct.png'), x=35, y=100, w=120, h=70, type='', link='')
    pdf.ln(h='')
    pdf.cell(10, 10, " ", 0, 1, 'C')
    pdf.image(os.path.join(output_plot_path, 'entropy_histogram_phasing.png'), x=35, y=180, w=120, h=70, type='', link='')

    pdf.ln(h='')
    pdf.cell(90, 50, " ", 0, 1, 'C')
    pdf.add_page()

    pdf.cell(110, 8, "Compression length of barcodes (higher values are better) ", 1, 1, 'C')
    pdf.image(os.path.join(output_plot_path, 'compression_histogram_naive.png'), x=35, y=20, w=120, h=70, type='', link='')
    pdf.ln(h='')
    pdf.cell(10, 10, " ", 0, 1, 'C')
    pdf.image(os.path.join(output_plot_path, 'compression_histogram_only_ct.png'), x=35, y=100, w=120, h=70, type='', link='')
    pdf.ln(h='')
    pdf.cell(10, 10, " ", 0, 1, 'C')
    pdf.image(os.path.join(output_plot_path, 'compression_histogram_phasing.png'), x=35, y=180, w=120, h=70, type='', link='')

    pdf.cell(125, 60, " ", 0, 1, 'C')
    pdf.add_page()

    pdf.cell(110, 8, "Confidences scores (higher values are better) ", 1, 1, 'C')
    pdf.image(os.path.join(output_plot_path, 'confidence_joyplot_naive.png'), x=35, y=20, w=120, h=85, type='', link='')
    pdf.ln(h='')
    pdf.cell(10, 10, " ", 0, 1, 'C')
    pdf.image(os.path.join(output_plot_path, 'confidence_joyplot_only_ct.png'), x=35, y=105, w=120, h=85, type='', link='')
    pdf.ln(h='')
    pdf.cell(10, 10, " ", 0, 1, 'C')
    pdf.image(os.path.join(output_plot_path, 'confidence_joyplot_phasing.png'), x=35, y=195, w=120, h=85, type='', link='')

    pdf.cell(125, 60, " ", 0, 1, 'C')
    pdf.add_page()

    pdf.cell(110, 8, "Number of good/bad basecalls per location ", 1, 1, 'C')
    pdf.image(os.path.join(output_plot_path, 'locs_0.85_naive.png'), x=35, y=20, w=130, h=80, type='', link='')
    pdf.ln(h='')
    pdf.cell(10, 10, " ", 0, 1, 'C')
    pdf.image(os.path.join(output_plot_path, 'locs_0.85_only_ct.png'), x=35, y=105, w=130, h=80, type='', link='')
    pdf.ln(h='')
    pdf.cell(10, 10, " ", 0, 1, 'C')
    pdf.image(os.path.join(output_plot_path, 'locs_0.85_phasing.png'), x=35, y=195, w=130, h=80, type='', link='')

    pdf.cell(125, 60, " ", 0, 1, 'C')
    pdf.add_page()

    pdf.cell(110, 8, "Number of beads with n good cycles ", 1, 1, 'C')
    pdf.image(os.path.join(output_plot_path, 'good_hist_0.85_naive.png'), x=35, y=20, w=130, h=80, type='', link='')
    pdf.ln(h='')
    pdf.cell(10, 10, " ", 0, 1, 'C')
    pdf.image(os.path.join(output_plot_path, 'good_hist_0.85_only_ct.png'), x=35, y=105, w=130, h=80, type='', link='')
    pdf.ln(h='')
    pdf.cell(10, 10, " ", 0, 1, 'C')
    pdf.image(os.path.join(output_plot_path, 'good_hist_0.85_phasing.png'), x=35, y=195, w=130, h=80, type='', link='')
    pdf.output(os.path.join(output_orig, report_name), 'F') 